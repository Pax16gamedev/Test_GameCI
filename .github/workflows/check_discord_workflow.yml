name: Check Discord Workflow
on:
  workflow_dispatch: {}
jobs:
  discord-integration:
    name: Discord integration
    runs-on: ubuntu-latest
    steps:
      - name: Set variables
        if: always()
        id: set-vars
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "STATUS=✅ La build para la rama **${{ github.ref_name }}** se ha completado con éxito." >> $GITHUB_ENV
            echo "COLOR=3066993" >> $GITHUB_ENV
          else
            echo "STATUS=❌ La build para la rama **${{ github.ref_name }}** ha fallado." >> $GITHUB_ENV
            echo "COLOR=15158332" >> $GITHUB_ENV
          fi

          echo "LINK_ACTION=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV

        # Set notification message
      - name: Set Discord Notification Message
        if: always()
        id: set-message
        run: |
          cat <<EOF > payload.json
          {
              "tts": false,
              "embeds": [
                {
                  "description": "${{ env.STATUS }}",
                  "color": "${{ env.COLOR }}",
                  "fields": [
                    { "name": "Rama ", "value": "${{ github.ref_name }}" },
                    { "name": "Plataforma ", "value": "TEST_WORKFLOW" },
                    { "name": "Workflow ", "value": "${{ env.LINK_ACTION }}" },
                    { "name": "Enlace ", "value": "TEST_WORKFLOW" },
                    { "name": "Duración ", "value": "TEST_WORKFLOW" }
                  ],
                  "footer": { 
                    "text": "GitHub Actions - Discord Integration", 
                    "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                  },
                  "author": {
                    "name": "Workflow terminado"
                  },
                  "timestamp": "${{ env.TIMESTAMP }}"
                }
              ]
            }
          EOF

        # Notify Discord
      - name: Notify Discord
        if: always()
        run: |
          if [ ! -f payload.json ]; then
            echo '{"content": "Error al construir el mensaje JSON para Discord ❌❌❌."}' > payload.json
          fi
          curl -H "Content-Type: application/json" \
          -d @payload.json \
          ${{ secrets.DISCORD_WEBHOOK_URL }}
