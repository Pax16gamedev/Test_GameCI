name: Check Discord Workflow
on:
  workflow_dispatch: {}
jobs:
  discord-integration:
    name: Discord integration 
    runs-on: ubuntu-latest
    steps:
      - name: Set variables
        if: always()
        id: set-vars
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="✅ La build para la rama **${{ github.ref_name }}** se ha completado con éxito."
            COLOR=3066993
          else
            STATUS="❌ La build para la rama **${{ github.ref_name }}** ha fallado."
            COLOR=15158332
          fi

          LINK_ACTION="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          echo "$STATUS" >> $GITHUB_ENV
          echo "$COLOR" >> $GITHUB_ENV
          echo "$LINK_ACTION" >> $GITHUB_ENV
          echo "$TIMESTAMP" >> $GITHUB_ENV

        # Set notification message
      - name: Set Discord Notification Message
        if: always()
        id: set-message
        run: |
          cat <<EOF > payload.json
          {
              "tts": false,
              "embeds": [
                {
                  "description": ${{ env.STATUS }},
                  "color": ${{ env.COLOR }},
                  "fields": [
                    { "name": "Rama ", "value": ${{ github.ref_name }} },
                    { "name": "Plataforma ", "value": TEST_WORKFLOW },
                    { "name": "Workflow ", "value": ${{ env.LINK_ACTION }} },
                    { "name": "Enlace ", "value": TEST_WORKFLOW },
                    { "name": "Duración ", "value": TEST_WORKFLOW }
                  ],
                  "footer": { 
                    "text": GitHub Actions - Discord Integration, 
                    "icon_url": https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png 
                  },
                  "author": {
                    "name": "Workflow terminado"
                  },
                  "timestamp": ${{ env.TIMESTAMP }}
                }
              ]
            }
          EOF

        # Notify Discord
      - name: Notify Discord
        if: always()
        run: |
          MESSAGE="${{ steps.set-message.outputs.message }}"
          if [ -z "$MESSAGE" ]; then
            MESSAGE='{"content": "Error al construir el mensaje JSON para Discord."}'
          fi
          curl -H "Content-Type: application/json" \
          -d "$MESSAGE" \
          ${{ secrets.DISCORD_WEBHOOK_URL }}